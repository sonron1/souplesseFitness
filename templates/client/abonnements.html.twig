{% extends 'base.html.twig' %}

{% block title %}Mes Abonnements{% endblock %}

{% macro renderAbonnementCard(abonnement, isAbonnementActuel, isPromo) %}
    <div class="card abonnement-card h-100 shadow-sm border-0 {% if isPromo %}promo-card{% endif %}">
        {% if isPromo %}
            <div class="badge-reduction">
                <span class="badge bg-danger text-white fw-bold">
                    -{{ ((abonnement.prixOriginal - abonnement.prix) / abonnement.prixOriginal * 100)|round }}%
                </span>
            </div>
        {% endif %}

        <div class="card-body p-3 d-flex flex-column">
            <!-- Header de la carte -->
            <div class="text-center mb-3">
                <div class="icon-container {% if abonnement.type == 'couple' or abonnement.type == 'mensuel_couple' %}bg-success{% elseif isPromo %}bg-danger{% else %}bg-dark{% endif %} text-white mx-auto mb-2">
                    {% if abonnement.type == 'couple' or abonnement.type == 'mensuel_couple' %}
                        <i class="bi bi-people-fill"></i>
                    {% elseif abonnement.type == 'seance' %}
                        <i class="bi bi-play-circle-fill"></i>
                    {% elseif abonnement.type == 'carnet' %}
                        <i class="bi bi-journal-text"></i>
                    {% else %}
                        <i class="bi bi-calendar-month-fill"></i>
                    {% endif %}
                </div>
                <h6 class="fw-bold mb-1">{{ abonnement.nom }}</h6>
                <span class="badge {% if abonnement.type == 'couple' or abonnement.type == 'mensuel_couple' %}bg-success{% elseif isPromo %}bg-danger{% else %}bg-dark{% endif %} badge-float">
                    {% if abonnement.type == 'seance' %}À l'unité
                    {% elseif abonnement.type == 'carnet' %}Carnet
                    {% elseif abonnement.type == 'mensuel_couple' %}Couple
                    {% else %}{{ abonnement.type|title }}
                    {% endif %}
                </span>
            </div>

            <!-- Description -->
            {% if abonnement.description %}
                <p class="description-fade text-muted small">{{ abonnement.description }}</p>
            {% else %}
                <div class="description-fade"></div>
            {% endif %}

            <!-- Prix -->
            <div class="price-container text-center">
                {% if isPromo and abonnement.prixOriginal %}
                    <div class="mb-1">
                        <small class="text-muted text-decoration-line-through">{{ abonnement.prixOriginal }}</small>
                    </div>
                {% endif %}
                <div class="d-flex align-items-baseline justify-content-center">
                    <span class="price-number">{{ abonnement.prix }}</span>
                    <span class="price-currency ms-1">FCFA</span>
                </div>
            </div>

            <!-- Caractéristiques -->
            <ul class="features-list list-unstyled small">
                <li class="feature-item"><i class="bi bi-check-circle-fill text-success me-1"></i>
                    {% if abonnement.dureeJours %}
                        Durée: {{ abonnement.dureeJours }} jours
                    {% else %}
                        Accès complet aux équipements
                    {% endif %}
                </li>
                <li class="feature-item"><i class="bi bi-check-circle-fill text-success me-1"></i>Cours collectifs inclus</li>
                <li class="feature-item"><i class="bi bi-check-circle-fill text-success me-1"></i>Suivi personnalisé</li>
                {% if abonnement.type == 'couple' or abonnement.type == 'mensuel_couple' %}
                    <li class="feature-item"><i class="bi bi-check-circle-fill text-success me-1"></i>Formule pour 2 personnes</li>
                {% endif %}
            </ul>

            <!-- Bouton -->
            <div class="mt-auto">
                {% if isAbonnementActuel %}
                    <button class="btn btn-success btn-current w-100" disabled>
                        <i class="bi bi-check-circle-fill me-1"></i>Abonnement actuel
                    </button>
                {% else %}
                    <button class="btn btn-dark btn-subscribe w-100"
                            data-bs-toggle="modal"
                            data-bs-target="#confirmModal"
                            data-abonnement-id="{{ abonnement.id }}"
                            data-abonnement-nom="{{ abonnement.nom }}"
                            data-abonnement-prix="{{ abonnement.prix }} FCFA"
                            data-abonnement-prix-original="{% if isPromo and abonnement.prixOriginal %}{{ abonnement.prixOriginal }} FCFA{% endif %}"
                            data-abonnement-type="{{ abonnement.type }}"
                            data-abonnement-description="{{ abonnement.description|default('Aucune description disponible') }}"
                            data-is-promo="{% if isPromo %}true{% else %}false{% endif %}">
                        <i class="bi bi-plus-circle-fill me-1"></i>Souscrire
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
{% endmacro %}

{% block body %}
    <div class="container py-4">
        <div class="row">
            <!-- Header -->
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h1 class="h3 mb-0 text-figma-dark">
                            <i class="bi bi-card-checklist me-2"></i>Mes Abonnements
                        </h1>
                        <p class="text-muted mb-0">Gérez vos abonnements fitness</p>
                    </div>
                    <div>
                        <a href="{{ path('client_dashboard') }}" class="btn btn-figma-outline-dark rounded-pill px-4">
                            <i class="bi bi-arrow-left me-1"></i>Retour au dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Abonnement actuel -->
        {% if client and client.abonnementActuel %}
            {% set dateFinAbonnement = client.dateFinAbonnement %}
            {% set abonnementExpire = dateFinAbonnement and dateFinAbonnement < date() %}

            <div class="row justify-content-center mb-4">
                <div class="col-lg-10">
                    <div class="abonnement-actuel bg-white rounded-3 shadow-sm p-3 border-start border-4 {% if abonnementExpire %}border-danger{% else %}border-success{% endif %}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-1">
                                    <i class="bi bi-star-fill text-figma-orange me-2 star-pulse"></i>
                                    Mon abonnement actuel
                                </h6>
                                <h5 class="text-figma-dark mb-2">{{ client.abonnementActuel.nom }}</h5>
                                <div class="row g-2">
                                    <div class="col-lg-3 col-md-6">
                                        <small class="text-muted d-block">Type</small>
                                        <span class="badge bg-figma-orange text-white badge-float">{{ client.abonnementActuel.type|title }}</span>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <small class="text-muted d-block">Prix</small>
                                        <strong class="price-bounce">{{ client.abonnementActuel.prix }} FCFA</strong>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <small class="text-muted d-block">Date de début</small>
                                        <span class="fw-medium">{{ client.dateDebutAbonnement ? client.dateDebutAbonnement|date('d/m/Y') : 'N/A' }}</span>
                                    </div>
                                    <div class="col-lg-3 col-md-6">
                                        <small class="text-muted d-block">Date de fin</small>
                                        <span class="fw-medium {% if abonnementExpire %}text-danger{% else %}text-success{% endif %}">
                                            {{ dateFinAbonnement ? dateFinAbonnement|date('d/m/Y') : 'N/A' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="ms-3">
                                {% if abonnementExpire %}
                                    <span class="badge bg-danger fs-6 px-2 py-1 badge-shake">Expiré</span>
                                {% else %}
                                    <span class="badge bg-success fs-6 px-2 py-1 badge-glow">Actif</span>
                                {% endif %}
                            </div>
                        </div>

                        {% if client.abonnementActuel.description %}
                            <hr>
                            <p class="text-muted mb-0 small">{{ client.abonnementActuel.description }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Filtres des abonnements -->
        <div class="row justify-content-center mb-4">
            <div class="col-lg-8">
                <div class="bg-white rounded-3 shadow-sm p-3">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h6 class="fw-bold mb-2 text-center">
                                <i class="bi bi-grid-3x3-gap-fill text-primary me-2"></i>
                                Abonnements disponibles
                            </h6>
                        </div>
                        <div class="col-md-6">
                            <select id="filterAbonnements" class="form-select form-select-sm" aria-label="Filtrer les abonnements">
                                <option value="all">Toutes les formules</option>
                                <option value="seance">Séances uniques</option>
                                <option value="carnet">Carnets de séances</option>
                                <option value="mensuel">Abonnements mensuels</option>
                                <option value="mensuel_couple">Abonnements couple</option>
                                <option value="trimestriel">Abonnements trimestriels</option>
                                <option value="annuel">Abonnements annuels</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ABONNEMENTS PROMO -->
        {% if abonnementsParCategorie.promo|length > 0 %}
            <div class="mb-5" id="promoSection">
                <div class="row justify-content-center mb-3">
                    <div class="col-lg-10">
                        <div class="section-header bg-gradient-danger text-white rounded-3 p-3 text-center position-relative overflow-hidden">
                            <div class="position-absolute top-0 start-0 w-100 h-100 bg-danger bg-opacity-10"></div>
                            <div class="position-relative">
                                <h5 class="fw-bold mb-1">
                                    <i class="bi bi-lightning-fill me-2"></i>🔥 PROMOTIONS LIMITÉES 🔥
                                </h5>
                                <p class="mb-0 small">Profitez de nos offres exceptionnelles !</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-none d-md-flex row justify-content-center g-3">
                    {% for abonnement in abonnementsParCategorie.promo %}
                        {% set isAbonnementActuel = client and client.abonnementActuel and client.abonnementActuel.id == abonnement.id %}
                        <div class="col-lg-3 col-md-4 abonnement-item" data-type="{{ abonnement.type }}" data-category="promo">
                            {{ _self.renderAbonnementCard(abonnement, isAbonnementActuel, true) }}
                        </div>
                    {% endfor %}
                </div>

                <!-- Version mobile avec scroll horizontal -->
                <div class="d-md-none abonnements-scroll" aria-label="Abonnements en promotion">
                    {% for abonnement in abonnementsParCategorie.promo %}
                        {% set isAbonnementActuel = client and client.abonnementActuel and client.abonnementActuel.id == abonnement.id %}
                        <div class="abonnement-item" data-type="{{ abonnement.type }}" data-category="promo">
                            {{ _self.renderAbonnementCard(abonnement, isAbonnementActuel, true) }}
                        </div>
                    {% endfor %}
                </div>
                <div class="scroll-indicator d-md-none">
                    <i class="bi bi-arrow-left-right"></i> Faites défiler pour voir plus
                </div>
            </div>
        {% endif %}

        <!-- ABONNEMENTS SIMPLES -->
        <div class="mb-5" id="simpleSection">
            <div class="row justify-content-center mb-3">
                <div class="col-lg-10">
                    <div class="section-header bg-primary text-white rounded-3 p-3 text-center">
                        <h5 class="fw-bold mb-1">
                            <i class="bi bi-person-fill me-2"></i>Abonnements Individuels
                        </h5>
                        <p class="mb-0 small">Formules personnelles pour votre remise en forme</p>
                    </div>
                </div>
            </div>

            <div class="d-none d-md-flex row justify-content-center g-3">
                {% for abonnement in abonnementsParCategorie.simple %}
                    {% set isAbonnementActuel = client and client.abonnementActuel and client.abonnementActuel.id == abonnement.id %}
                    <div class="col-lg-3 col-md-4 abonnement-item" data-type="{{ abonnement.type }}" data-category="simple">
                        {{ _self.renderAbonnementCard(abonnement, isAbonnementActuel, false) }}
                    </div>
                {% endfor %}
            </div>

            <!-- Version mobile avec scroll horizontal -->
            <div class="d-md-none abonnements-scroll" aria-label="Abonnements individuels">
                {% for abonnement in abonnementsParCategorie.simple %}
                    {% set isAbonnementActuel = client and client.abonnementActuel and client.abonnementActuel.id == abonnement.id %}
                    <div class="abonnement-item" data-type="{{ abonnement.type }}" data-category="simple">
                        {{ _self.renderAbonnementCard(abonnement, isAbonnementActuel, false) }}
                    </div>
                {% endfor %}
            </div>
            <div class="scroll-indicator d-md-none">
                <i class="bi bi-arrow-left-right"></i> Faites défiler pour voir plus
            </div>
        </div>

        <!-- ABONNEMENTS COUPLE -->
        {% if abonnementsParCategorie.couple|length > 0 %}
            <div class="mb-5" id="coupleSection">
                <div class="row justify-content-center mb-3">
                    <div class="col-lg-10">
                        <div class="section-header bg-success text-white rounded-3 p-3 text-center">
                            <h5 class="fw-bold mb-1">
                                <i class="bi bi-people-fill me-2"></i>Abonnements Couple
                            </h5>
                            <p class="mb-0 small">Entraînez-vous à deux et économisez !</p>
                        </div>
                    </div>
                </div>

                <div class="d-none d-md-flex row justify-content-center g-3">
                    {% for abonnement in abonnementsParCategorie.couple %}
                        {% set isAbonnementActuel = client and client.abonnementActuel and client.abonnementActuel.id == abonnement.id %}
                        <div class="col-lg-3 col-md-4 abonnement-item" data-type="{{ abonnement.type }}" data-category="couple">
                            {{ _self.renderAbonnementCard(abonnement, isAbonnementActuel, false) }}
                        </div>
                    {% endfor %}
                </div>

                <!-- Version mobile avec scroll horizontal -->
                <div class="d-md-none abonnements-scroll" aria-label="Abonnements couple">
                    {% for abonnement in abonnementsParCategorie.couple %}
                        {% set isAbonnementActuel = client and client.abonnementActuel and client.abonnementActuel.id == abonnement.id %}
                        <div class="abonnement-item" data-type="{{ abonnement.type }}" data-category="couple">
                            {{ _self.renderAbonnementCard(abonnement, isAbonnementActuel, false) }}
                        </div>
                    {% endfor %}
                </div>
                <div class="scroll-indicator d-md-none">
                    <i class="bi bi-arrow-left-right"></i> Faites défiler pour voir plus
                </div>
            </div>
        {% endif %}

        <!-- Message si aucun abonnement -->
        {% if abonnements|length == 0 %}
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="bg-white rounded-3 shadow-sm p-4 text-center empty-state">
                        <i class="bi bi-card-text fs-1 text-muted mb-3 empty-icon"></i>
                        <h6 class="text-muted mb-2">Aucun abonnement disponible</h6>
                        <p class="text-muted small">Les abonnements seront bientôt disponibles.</p>
                        <a href="{{ path('app_home') }}#contact" class="btn btn-figma-yellow rounded-pill btn-contact">
                            <i class="bi bi-envelope me-1"></i>Nous contacter
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Modal de confirmation -->
    <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg">
                <div class="modal-header bg-figma-yellow border-0 text-center">
                    <div class="w-100">
                        <div class="text-center mb-2">
                            <i class="bi bi-star-fill fs-3 text-figma-dark"></i>
                        </div>
                        <h5 class="modal-title fw-bold text-figma-dark" id="confirmModalLabel">
                            Confirmer votre abonnement
                        </h5>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center mb-4">
                        <div id="modal-promo-badge" class="d-none mb-3">
                            <span class="badge bg-danger fs-6 px-3 py-2">🔥 PROMOTION ACTIVE</span>
                        </div>
                        <div class="bg-figma-yellow bg-opacity-20 rounded-circle p-3 d-inline-flex mb-3">
                            <i class="bi bi-credit-card-2-front fs-2 text-figma-dark"></i>
                        </div>
                        <h5 class="fw-bold mb-2" id="modal-abonnement-nom">Nom de l'abonnement</h5>
                        <span class="badge bg-primary mb-3" id="modal-abonnement-type">Type</span>
                        <p class="text-muted small" id="modal-abonnement-description">Description de l'abonnement</p>
                    </div>

                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <div class="bg-light rounded-3 p-3 text-center">
                                <div id="modal-prix-original" class="d-none mb-1">
                                    <small class="text-muted text-decoration-line-through">
                                        Prix original: <span id="modal-prix-original-value">0 FCFA</span>
                                    </small>
                                </div>
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="fs-4 fw-bold text-primary me-2">Prix final:</span>
                                    <span class="fs-4 fw-bold text-figma-orange" id="modal-prix-final">0 FCFA</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        <strong>Important :</strong> En confirmant, votre abonnement sera activé immédiatement.
                    </div>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <form id="confirmForm" method="post" action="">
                        <input type="hidden" name="_token" value="{{ csrf_token('subscribe_abonnement') }}">
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end w-100">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="bi bi-x-circle me-1"></i>Annuler
                            </button>
                            <button type="submit" class="btn btn-figma-yellow">
                                <i class="bi bi-check-circle me-1"></i>Confirmer l'abonnement
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
